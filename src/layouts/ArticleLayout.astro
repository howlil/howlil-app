---
import BaseLayout from "./BaseLayout.astro";
import TableOfContents from "../components/TableOfContents";
import ArrowLink from "../components/ArrowLink.astro";

interface Props {
  title: string;
  description?: string;
  articleTitle: string;
  date: string;
  backHref: string;
  backLabel: string;
  tags?: string[];
  tagLinkPrefix?: string;
  readingTime?: number;
}

const {
  title,
  description,
  articleTitle,
  date,
  backHref,
  backLabel,
  tags = [],
  tagLinkPrefix = '',
  readingTime = 0,
} = Astro.props;

const currentUrl = Astro.url.href;
---

<BaseLayout title={title} description={description}>
  <main class="pt-24 pb-10 px-6">
    <div class="max-w-7xl mx-auto">
      <div class="max-w-[650px] mx-auto mb-8 lg:ml-auto lg:mr-[calc(250px+4.5rem)]">
        <!-- Back Button and Date -->
        <div class="flex items-center justify-between mb-6">
          <ArrowLink href={backHref} label={backLabel} direction="back" />
          <span class="text-sm text-gray-600">{date}</span>
        </div>

        <!-- Title -->
        <h1 class="text-3xl font-bold text-gray-800 mb-4">{articleTitle}</h1>

        <!-- Tags/Meta Slot -->
        <slot name="meta" />

        <!-- Default Tags if not using slot -->
        {tags && tags.length > 0 && !Astro.slots.has('meta') && (
          <div class="mb-8">
            <div class="flex items-center gap-2 flex-wrap">
              {tags.map((tag: string) => (
                <a
                  href={`${tagLinkPrefix}?tag=${encodeURIComponent(tag)}`}
                  class="px-3 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 hover:text-gray-800 text-xs rounded-full transition-colors cursor-pointer"
                >
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )}
      </div>

      <!-- Content with TOC - 3 columns: empty, content, TOC -->
      <div class="grid grid-cols-1 lg:grid-cols-[1fr_650px_250px] gap-18">
        <!-- Empty space on left for balance -->
        <div class="hidden lg:block"></div>
        
        <!-- Main Content Area -->
        <div>
          <!-- Cover/Media Slot -->
          <slot name="cover" />
          
          <!-- Article Stats -->
          <div class="flex items-center justify-between py-4 mb-6 border-b border-gray-200 text-sm text-gray-600">
            <div class="flex items-center gap-6">
              <!-- Like Button -->
              <button 
                id="like-btn"
                class="flex items-center gap-1.5 hover:text-red-500 transition-colors cursor-pointer"
                data-slug={Astro.url.pathname}
              >
                <svg id="like-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                <span id="like-count">0</span>
              </button>
              
              <!-- Views -->
              <div class="flex items-center gap-1.5" data-slug={Astro.url.pathname} id="view-container">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                </svg>
                <span id="view-count">--</span>
                <span>views</span>
              </div>
              
              <!-- Reading Time (hidden when 0, e.g. project pages without readingTime) -->
              {readingTime > 0 && (
                <div class="flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <span>{readingTime} min read</span>
                </div>
              )}
            </div>
            
            <!-- Share Button -->
            <button 
              id="share-btn"
              class="flex items-center gap-1.5 hover:text-gray-800 transition-colors cursor-pointer"
              data-url={currentUrl}
              data-title={articleTitle}
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
              </svg>
              <span>Share</span>
            </button>
          </div>

          <!-- Optional slot for project: links, short explanation, goals -->
          <slot name="beforeContent" />
          
          <!-- Article Content -->
          <article class="prose prose-sm" id="article-content">
            <slot />
          </article>
        </div>

        <!-- Table of Contents -->
        <TableOfContents client:load />
      </div>
    </div>
  </main>

  <!-- Image Modal Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const showImageModal = (imageUrl: string, alt: string) => {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-[100] flex items-center justify-center p-4';
        modal.id = 'image-modal';
        modal.innerHTML = `
          <div class="absolute inset-0 bg-black/80 backdrop-blur-md" id="modal-backdrop"></div>
          <button class="absolute top-4 right-4 z-10 bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-colors" id="modal-close">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
          <div class="relative z-10 max-w-7xl max-h-[90vh] w-full" id="modal-content">
            <img src="${imageUrl}" alt="${alt}" class="w-full h-full object-contain rounded-lg" />
          </div>
        `;
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        const closeModal = () => {
          const modalEl = document.getElementById('image-modal');
          if (modalEl) modalEl.remove();
          document.body.style.overflow = '';
        };

        document.getElementById('modal-backdrop')?.addEventListener('click', closeModal);
        document.getElementById('modal-close')?.addEventListener('click', closeModal);
        document.getElementById('modal-content')?.addEventListener('click', (e) => e.stopPropagation());

        const handleEsc = (e: KeyboardEvent) => {
          if (e.key === 'Escape') closeModal();
        };
        document.addEventListener('keydown', handleEsc);
        
        const observer = new MutationObserver(() => {
          if (!document.getElementById('image-modal')) {
            document.removeEventListener('keydown', handleEsc);
            observer.disconnect();
          }
        });
        observer.observe(document.body, { childList: true });
      };

      // Handle all images in article
      const articleContent = document.getElementById('article-content');
      if (articleContent) {
        const images = articleContent.querySelectorAll('img');
        images.forEach((img) => {
          (img as HTMLElement).style.cursor = 'pointer';
          img.addEventListener('click', () => {
            showImageModal(img.getAttribute('src') || '', img.getAttribute('alt') || '');
          });
        });
      }

      // Handle cover image if exists
      const coverImage = document.getElementById('cover-image');
      if (coverImage) {
        (coverImage as HTMLElement).style.cursor = 'pointer';
        coverImage.addEventListener('click', () => {
          showImageModal(coverImage.getAttribute('src') || '', coverImage.getAttribute('alt') || '');
        });
      }

      // Share button functionality
      const shareBtn = document.getElementById('share-btn');
      if (shareBtn) {
        shareBtn.addEventListener('click', async () => {
          const url = shareBtn.getAttribute('data-url') || window.location.href;
          const title = shareBtn.getAttribute('data-title') || document.title;
          
          if (navigator.share) {
            try {
              await navigator.share({ title, url });
            } catch (err) {
              // User cancelled or error
            }
          } else {
            // Fallback: copy to clipboard
            try {
              await navigator.clipboard.writeText(url);
              const span = shareBtn.querySelector('span');
              if (span) {
                const originalText = span.textContent;
                span.textContent = 'Copied!';
                setTimeout(() => {
                  span.textContent = originalText;
                }, 2000);
              }
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          }
        });
      }

      // View counter functionality
      const viewContainer = document.getElementById('view-container');
      const viewCount = document.getElementById('view-count');
      
      if (viewContainer && viewCount) {
        const slug = viewContainer.getAttribute('data-slug') || '';
        const viewedKey = `blog-viewed-${slug}`;
        
        // Check if already viewed in this session
        const hasViewed = sessionStorage.getItem(viewedKey) === 'true';
        
        // Fetch and increment view
        const trackView = async () => {
          try {
            if (!hasViewed) {
              // Increment view count
              const res = await fetch('/api/views', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slug }),
              });
              const data = await res.json();
              viewCount.textContent = data.count?.toString() || '0';
              sessionStorage.setItem(viewedKey, 'true');
            } else {
              // Just fetch current count
              const res = await fetch(`/api/views?slug=${encodeURIComponent(slug)}`);
              const data = await res.json();
              viewCount.textContent = data.count?.toString() || '0';
            }
          } catch (err) {
            console.error('Failed to track view:', err);
          }
        };
        
        trackView();
      }

      // Like button functionality (Astro DB based)
      const likeBtn = document.getElementById('like-btn');
      const likeIcon = document.getElementById('like-icon');
      const likeCount = document.getElementById('like-count');
      
      if (likeBtn && likeIcon && likeCount) {
        const slug = likeBtn.getAttribute('data-slug') || '';
        const likedKey = `blog-liked-${slug}`;
        
        // Generate or get visitor ID
        const getVisitorId = (): string => {
          let visitorId = localStorage.getItem('visitor-id');
          if (!visitorId) {
            visitorId = 'v_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
            localStorage.setItem('visitor-id', visitorId);
          }
          return visitorId;
        };
        
        // Check if user already liked this post (local cache)
        const hasLikedLocal = (): boolean => {
          return localStorage.getItem(likedKey) === 'true';
        };
        
        // Update UI
        const updateLikeUI = (count: number, liked: boolean) => {
          likeCount.textContent = count.toString();
          
          if (liked) {
            likeIcon.setAttribute('fill', 'currentColor');
            likeBtn.classList.add('text-red-500');
          } else {
            likeIcon.setAttribute('fill', 'none');
            likeBtn.classList.remove('text-red-500');
          }
        };
        
        // Fetch initial like count
        const fetchLikes = async () => {
          try {
            const res = await fetch(`/api/likes?slug=${encodeURIComponent(slug)}`);
            const data = await res.json();
            updateLikeUI(data.count || 0, hasLikedLocal());
          } catch (err) {
            console.error('Failed to fetch likes:', err);
          }
        };
        
        // Initialize
        fetchLikes();
        
        // Handle click
        likeBtn.addEventListener('click', async () => {
          const visitorId = getVisitorId();
          
          try {
            const res = await fetch('/api/likes', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ slug, visitorId }),
            });
            
            const data = await res.json();
            
            if (data.liked) {
              localStorage.setItem(likedKey, 'true');
            } else {
              localStorage.removeItem(likedKey);
            }
            
            updateLikeUI(data.count, data.liked);
          } catch (err) {
            console.error('Failed to toggle like:', err);
          }
        });
      }
    });
  </script>
</BaseLayout>

<style is:global>
  .prose {
    color: #44403C;
    max-width: 100%;
    font-family: 'Spectral', 'Times New Roman', serif;
    text-align: justify;
  }
  
  .prose h1 {
    display: none;
  }
  
  .prose h2 {
    font-size: 1.5rem;
    font-weight: 600;
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: #1C1917;
    scroll-margin-top: 100px;
  }

  
  .prose h3 {
    font-size: 1.25rem;
    font-weight: 600;
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    color: #1C1917;
    scroll-margin-top: 100px;
  }
  
  .prose h4 {
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: #1C1917;
  }
  
  .prose p {
    margin-bottom: 1rem;
    line-height: 1.7;
    color: #44403C;
    font-family: 'Spectral', 'Times New Roman', serif;
  }
  
  .prose ul {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    list-style-type: disc;
  }
  
  .prose ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
    list-style-type: decimal;
  }
  
  .prose li {
    margin-bottom: 0.5rem;
    color: #44403C;
    font-family: 'Spectral', 'Times New Roman', serif;
    display: list-item;
  }
  
  .prose strong {
    font-weight: 600;
    color: #1C1917;
  }
  
  .prose code {
    color: #78716C;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-family: 'Courier New', monospace;
  }
  
  .prose pre {
    background-color: #2B2B2B;
    color: #F9FAFB;
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-bottom: 1rem;
  }
  
  .prose pre code {
    background-color: transparent;
    padding: 0;
    color: #F9FAFB;
  }
  
  .prose hr {
    border-top: 1px solid #E5E7EB;
    margin: 2rem 0;
  }

  /* Tables - clear alignment and readability (Keputusan | Alasan | Alternatif) */
  .prose table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1.5rem;
    display: table;
    table-layout: fixed;
  }
  .prose th,
  .prose td {
    border: 1px solid #E5E7EB;
    padding: 0.625rem 0.75rem;
    text-align: left;
    vertical-align: top;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .prose table th:nth-child(1),
  .prose table td:nth-child(1) { width: 22%; min-width: 0; }
  .prose table th:nth-child(2),
  .prose table td:nth-child(2) { width: 48%; min-width: 0; }
  .prose table th:nth-child(3),
  .prose table td:nth-child(3) { width: 30%; min-width: 0; }
  .prose th {
    background-color: #F3F4F6;
    font-weight: 600;
    font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    color: #1C1917;
  }
  .prose td {
    color: #44403C;
    font-family: 'Spectral', 'Times New Roman', serif;
  }
  .prose thead tr {
    border-bottom: 2px solid #D1D5DB;
  }
  .prose tbody tr:nth-child(even) td {
    background-color: #F9FAFB;
  }
  
  .prose a {
    color: #2563EB;
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  
  .prose a:hover {
    color: #1D4ED8;
  }

  .prose img {
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .prose img:hover {
    opacity: 0.9;
  }

  /* Dark mode - Paper Theme */
  html.dark .prose {
    color: #D6D3D1;
  }
  
  /* Headers */
  html.dark .prose h1,
  html.dark .prose h2,
  html.dark .prose h3,
  html.dark .prose h4,
  html.dark .prose h5,
  html.dark .prose h6,
  html.dark .prose strong {
    color: #F5F5F4;
  }
  
  /* Paragraph */
  html.dark .prose p,
  html.dark .prose li {
    color: #D6D3D1;
  }
  
  html.dark .prose code {
    color: #D6D3D1;
  }
  
  html.dark .prose hr {
    border-color: #44403C;
  }

  html.dark .prose th,
  html.dark .prose td {
    border-color: #44403C;
  }
  html.dark .prose th {
    background-color: #292524;
    color: #F5F5F4;
  }
  html.dark .prose td {
    color: #D6D3D1;
  }
  html.dark .prose thead tr {
    border-bottom-color: #57534E;
  }
  html.dark .prose tbody tr:nth-child(even) td {
    background-color: #1C1917;
  }
  
  html.dark .bg-gray-100 {
    background-color: #292524 !important;
  }

  html.dark .prose a {
    color: #A3A3A3;
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Article stats dark mode */
  html.dark .border-gray-200 {
    border-color: #44403C !important;
  }
</style>

